# Generated by kubexm. DO NOT EDIT.

global_defs {
  notification_email {
    # sysadmin@example.com
  }
  router_id KUBEXM_LVS
  vrrp_skip_check_adv_addr
  vrrp_garp_interval 0
  vrrp_gna_interval 0
}

# This script checks if the local HAProxy/NGINX process is running.
# If it's not, Keepalived will lower its own priority,
# potentially causing a failover to a healthy node.
vrrp_script chk_lb {
  # "killall -0 haproxy" or "pidof nginx"
  # You can make this configurable based on which LB is used.
  script "killall -0 haproxy" 
  interval 2
  weight -20  # Lower priority by 20 if script fails
  fall 2
  rise 2
}

vrrp_instance VI_K8S_API {
  state {{ .State }}
  interface {{ .Interface }}
  virtual_router_id {{ .VirtualRouterID }}
  priority {{ .Priority }}
  advert_int 1

  authentication {
    auth_type PASS
    auth_pass "{{ .AuthenticationPass }}"
  }

  # Unicast is preferred over multicast for better network control.
  unicast_src_ip {{ .UnicastSrcIP }}
  unicast_peer {
    {{- range .UnicastPeers }}
    {{ . }}
    {{- end }}
  }

  virtual_ipaddress {
    {{ .VirtualIP }}/32 dev {{ .Interface }}
  }

  track_script {
    chk_lb
  }
}